# PEM to JWK for Smart Cards

This utility converts a `.pem` file to a JWK in accordance to the [Smart Health Cards Framework](https://smarthealth.cards/#generating-and-resolving-cryptographic-keys)

The JWK is used to sign the Verifiable Credential payload.

The SSL keys must be of `EC` kind (NOT the usual `RSA`), using the `ES256` algorithm with a `P-256` elliptic curve.

The keys can then be converted to JWK format.

This utility can also convert signed certificates to JWK, as long as they are in PEM format.

The `pem2jwk.sh` utility can be used to convert the provided certificate `.pem` to its `jwk` representation.

## Contents:
1. [Manually generating keys for internal testing](#Manually-generating-keys-for-internal-testing)
2. [Generating VA-signed certificates for lower environments](#Generating-VA-signed-certificates-for-lower-environments)
3. [Generating CA-signed certificates for production](#Generating-CA-signed-certificates-for-production)
4. [Convert PEM to JWK](#Convert-PEM-to-JWK)

---

TLDR for local keys:

```
# generate private key
openssl ecparam -name prime256v1 -genkey -noout -out private-key.pem

# generate corresponding public key
openssl ec -in private-key.pem -pubout -out public-key.pem

# OPTIONAL: generate self-signed certificate
openssl req -new -x509 -key private-key.pem -out cert.pem -days 1825

# Convert PEM to JWK
./pem2jwk private-key.pem
```

---

## Manually generating keys for internal testing

Use `openssl` to generate the private and public keys, and issue a self-signed certificate.

(Replace file names with whatever you desire)

1. Create private key with `EC` kind and `P256` curve:
```
openssl ecparam -name prime256v1 -genkey -noout -out private-key.pem
```

2. Generate corresponding public key:
```
# generate corresponding public key
openssl ec -in private-key.pem -pubout -out public-key.pem
```

3. OPTIONAL: Issue self-signed certificate with 5-year expiration period:
```
openssl req -new -x509 -key private-key.pem -out cert.pem -days 1825
```

## Generating VA-signed certificates for lower environments

**NOTE** That this is not yet required. Only bare key discovery is under scope of the spec.

Create a new request on Github [lighthouse-devops-support](https://github.com/department-of-veterans-affairs/lighthouse-devops-support/issues). Example previous request [here](https://github.com/department-of-veterans-affairs/lighthouse-devops-support/issues/183).

### `Method 1: provide parameters`

The request body should include the following information
```
[ ecparam ]
name = prime256v1
genkey = true
noout = true

[ dn ]
C = US
ST = DC
L = Washington
O = Department of Veterans Affairs
OU = DVP
CN = production.smart-cards.lighthouse.va.gov
```

### `Method 2: provide CSR`

Alternatively, you can provide the request in CSR format:

1. Create CSR file:

**Change `CN` value to environment domain**
```
openssl ecparam -out production-smart-cards_lighthouse_va_gov.pkey -name prime256v1 -genkey && openssl req -new -key production-smart-cards_lighthouse_va_gov.pkey -nodes -out production-smart-cards_lighthouse_va_gov.csr -subj '/C=US/ST=DC/L=Washington/O=DVP/OU=Department of Veterans Affairs/CN=production-smart-cards.lighthouse.va.gov'
```

If you're using *Git for Windows* (aka Git Bash), you must provide an extra double slash value at the beginning of the `-subj` value, to suppress a slash translation problem:

```
winpty openssl ecparam -out production-smart-cards_lighthouse_va_gov.pkey -name prime256v1 -genkey && winpty openssl req -new -key production-smart-cards_lighthouse_va_gov.pkey -nodes -out production-smart-cards_lighthouse_va_gov.csr -subj '//C=US/C=US/ST=DC/L=Washington/O=DVP/OU=Department of Veterans Affairs/CN=production-smart-cards.lighthouse.va.gov'
```

2. Verify output CSR:
```
openssl req -text -in your-output-file.csr -noout -verify
```
Look for `verify OK` and `Subject: ` fields in output:
```
(some values truncated with ...)

Certificate Request:
    Data:
        Version: 1 (0x0)
        Subject: C = US, ST = DC, L = Washington, O = DVP, OU = Department of Veterans Affairs, CN = production-smart-cards.lighthouse.va.gov
        Subject Public Key Info:
            Public Key Algorithm: id-ecPublicKey
                Public-Key: (256 bit)
                pub:
                    ...
                ASN1 OID: prime256v1
                NIST CURVE: P-256
        Attributes:
            ...
    Signature Algorithm: ecdsa-with-SHA256
         ...
verify OK

```

3. Attach CSR file to DevOps request.

## Generating CA-signed certificates for production

**NOTE** That this is not yet required. Only bare key discovery is under scope of the spec.

Production certificates must be signed by an external, known Certificate Authority (CA). These are normally generated by the VA with the `SSLMate` tool. [Send a reques to Devops](#Generating-VA-signed-certificates-for-lower-environments), but specify that this must be an external, CA-signed cert created through SSLMate, NOT Venafi.

Note that these certs have a **1-year expiration**.

---

## Convert PEM to JWK

When a `.pem` file is generated, use the `pem2jwk.sh` script to convert to JWK. The script outputs the JWK to stdout.

```
./pem2jwk /path/to/private-key.pem
```

**CAREFUL**: If using the private key PEM as the input file, the util's output includes both private and public JWK representations. The private JWK should be protected and encrypted before storing.

The `Input to...` lines are generated from the input file without applying any modifications.

The `Output to...` lines are generated after adding additional required fields to the JWK.

Sample output:
```
./pem2jwk.sh /path/to/file.pem
From /path/to/file.pem:
Type                  : EC
Use                   : null
Thumb                 : <<Thumbprint in BASE64>>
Input to json         : {"kty":"EC","crv":"P-256","x":"...","y":"..."}
Input to PUBLIC json  : {"kty":"EC","crv":"P-256","x":"...","y":"..."}
Output to json        : {"kty":"EC","use":"sig","crv":"P-256","kid":"<<Thumbprint in BASE64>>","x":"...","y":"...","alg":"ES256"}
Output to PUBLIC json : {"kty":"EC","use":"sig","crv":"P-256","kid":"<<Thumbprint in BASE64>>","x":"...","y":"...","alg":"ES256"}

```

## Resources

Following guides were used to come up with this approach.
 - https://www.digicert.com/kb/ssl-support/openssl-quick-reference-guide.htm
 - https://www.scottbrady91.com/OpenSSL/Creating-Elliptical-Curve-Keys-using-OpenSSL
 - https://ruleoftech.com/2020/generating-jwt-and-jwk-for-information-exchange-between-services
 - https://connect2id.com/products/nimbus-jose-jwt

CSR Command Generator:
 - https://www.digicert.com/easy-csr/openssl.htm
